
    def show_unregistered_students(self):
        """Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„Ù‡Ù… ÙÙŠ ØªØ§Ø±ÙŠØ® Ù…Ø¹ÙŠÙ† Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø©"""
        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯
        selected_date = self.date_entry.get_date().strftime("%Y-%m-%d")

        # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
        unregistered_window = tk.Toplevel(self.root)
        unregistered_window.title(f"Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨ØªØ§Ø±ÙŠØ® {selected_date}")
        unregistered_window.geometry("800x600")
        unregistered_window.configure(bg=self.colors["light"])

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        x = (unregistered_window.winfo_screenwidth() - 800) // 2
        y = (unregistered_window.winfo_screenheight() - 600) // 2
        unregistered_window.geometry(f"800x600+{x}+{y}")

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©
        tk.Label(
            unregistered_window,
            text=f"Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø¨ØªØ§Ø±ÙŠØ® {selected_date}",
            font=self.fonts["title"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=10
        ).pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¯ÙˆØ±Ø©
        filter_frame = tk.Frame(unregistered_window, bg=self.colors["light"], padx=10, pady=10)
        filter_frame.pack(fill=tk.X)

        tk.Label(
            filter_frame,
            text="Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        ).pack(side=tk.RIGHT, padx=10)

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©
        cursor = self.conn.cursor()
        cursor.execute("SELECT DISTINCT course FROM trainees WHERE is_excluded=0 ORDER BY course")
        courses = ["Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª"] + [row[0] for row in cursor.fetchall() if row[0]]

        course_var = tk.StringVar(value="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª")
        course_combo = ttk.Combobox(
            filter_frame,
            textvariable=course_var,
            values=courses,
            state="readonly",
            width=30,
            font=self.fonts["text"]
        )
        course_combo.pack(side=tk.RIGHT, padx=5)

        # Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØµÙØ­ Ø§Ù„Ù…Ø­Ø¯ÙˆØ¯
        page_size = 100
        current_page = 1

        # Ø²Ø± ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ©
        filter_btn = tk.Button(
            filter_frame,
            text="ØªØ·Ø¨ÙŠÙ‚",
            font=self.fonts["text_bold"],
            bg=self.colors["primary"],
            fg="white",
            padx=10, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: load_students(1)  # Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø¯ÙˆØ±Ø©ØŒ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        )
        filter_btn.pack(side=tk.LEFT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„ØªØµÙØ­
        result_frame = tk.Frame(unregistered_window, bg=self.colors["light"], padx=10, pady=10)
        result_frame.pack(fill=tk.BOTH, expand=True)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
        list_frame = tk.Frame(result_frame, bg=self.colors["light"])
        list_frame.pack(fill=tk.BOTH, expand=True)

        # Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ…Ø±ÙŠØ± Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
        list_scroll = tk.Scrollbar(list_frame)
        list_scroll.pack(side=tk.RIGHT, fill=tk.Y)

        # Ø¥Ù†Ø´Ø§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†
        students_tree = ttk.Treeview(
            list_frame,
            columns=("id", "name", "rank", "course"),
            show="headings",
            yscrollcommand=list_scroll.set,
            style="Bold.Treeview"
        )

        # ØªØ¹Ø±ÙŠÙ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
        students_tree.column("id", width=120, anchor=tk.CENTER)
        students_tree.column("name", width=200, anchor=tk.CENTER)
        students_tree.column("rank", width=100, anchor=tk.CENTER)
        students_tree.column("course", width=150, anchor=tk.CENTER)

        # ØªØ¹Ø±ÙŠÙ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        students_tree.heading("id", text="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©")
        students_tree.heading("name", text="Ø§Ù„Ø§Ø³Ù…")
        students_tree.heading("rank", text="Ø§Ù„Ø±ØªØ¨Ø©")
        students_tree.heading("course", text="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ±Ø©")

        students_tree.pack(fill=tk.BOTH, expand=True)
        list_scroll.config(command=students_tree.yview)

        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ù…Ù„ØµÙ‚ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†
        students_count_var = tk.StringVar(value="Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: 0")
        students_count_label = tk.Label(
            result_frame,
            textvariable=students_count_var,
            font=self.fonts["text_bold"],
            bg=self.colors["light"],
            fg=self.colors["primary"],
            pady=5
        )
        students_count_label.pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµÙØ­
        pagination_frame = tk.Frame(result_frame, bg=self.colors["light"])
        pagination_frame.pack(fill=tk.X, pady=5)

        # Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØµÙØ­
        prev_btn = tk.Button(
            pagination_frame,
            text="Ø§Ù„Ø³Ø§Ø¨Ù‚",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=10, pady=2,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: change_page(-1)
        )
        prev_btn.pack(side=tk.LEFT, padx=5)

        page_var = tk.StringVar(value="Ø§Ù„ØµÙØ­Ø© 1")
        page_label = tk.Label(
            pagination_frame,
            textvariable=page_var,
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        )
        page_label.pack(side=tk.LEFT, padx=10)

        next_btn = tk.Button(
            pagination_frame,
            text="Ø§Ù„ØªØ§Ù„ÙŠ",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=10, pady=2,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: change_page(1)
        )
        next_btn.pack(side=tk.LEFT, padx=5)

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        tk.Button(
            unregistered_window,
            text="Ø¥ØºÙ„Ø§Ù‚",
            font=self.fonts["text_bold"],
            bg=self.colors["dark"],
            fg="white",
            padx=15, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=unregistered_window.destroy
        ).pack(side=tk.BOTTOM, pady=10)

        # Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØªØ¨Ø¹ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª ÙˆØ§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        total_pages = 1

        def change_page(delta):
            """ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©"""
            nonlocal current_page
            new_page = current_page + delta

            if 1 <= new_page <= total_pages:
                current_page = new_page
                load_students(current_page)

        # Ø¯Ø§Ù„Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆØ§Ù„ØµÙØ­Ø©
        def load_students(page=1):
            nonlocal current_page, total_pages
            current_page = page

            # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            for item in students_tree.get_children():
                students_tree.delete(item)

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
            selected_course = course_var.get()

            # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹
            count_query = ""
            count_params = []

            if selected_course == "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª":
                # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª
                count_query = """
                    SELECT COUNT(*)
                    FROM trainees t
                    WHERE t.is_excluded = 0
                    AND t.national_id NOT IN (
                        SELECT national_id FROM attendance WHERE date = ?
                    )
                """
                count_params = [selected_date]
            else:
                # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙÙ‚Ø·
                count_query = """
                    SELECT COUNT(*)
                    FROM trainees t
                    WHERE t.is_excluded = 0
                    AND t.course = ?
                    AND t.national_id NOT IN (
                        SELECT national_id FROM attendance WHERE date = ?
                    )
                """
                count_params = [selected_course, selected_date]

            # ØªÙ†ÙÙŠØ° Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø¹Ø¯Ø¯
            cursor.execute(count_query, count_params)
            total_count = cursor.fetchone()[0]

            # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª
            total_pages = max(1, (total_count + page_size - 1) // page_size)

            # ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØµÙØ­
            page_var.set(f"Ø§Ù„ØµÙØ­Ø© {current_page} Ù…Ù† {total_pages}")
            students_count_var.set(f"Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: {total_count}")

            # Ø¨Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù…Ø¹ Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙØ­Ø©
            offset = (current_page - 1) * page_size

            query = ""
            params = []

            if selected_course == "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª":
                query = """
                    SELECT t.national_id, t.name, t.rank, t.course
                    FROM trainees t
                    WHERE t.is_excluded = 0
                    AND t.national_id NOT IN (
                        SELECT national_id FROM attendance WHERE date = ?
                    )
                    ORDER BY t.course, t.name
                    LIMIT ? OFFSET ?
                """
                params = [selected_date, page_size, offset]
            else:
                query = """
                    SELECT t.national_id, t.name, t.rank, t.course
                    FROM trainees t
                    WHERE t.is_excluded = 0
                    AND t.course = ?
                    AND t.national_id NOT IN (
                        SELECT national_id FROM attendance WHERE date = ?
                    )
                    ORDER BY t.name
                    LIMIT ? OFFSET ?
                """
                params = [selected_course, selected_date, page_size, offset]

            # ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
            cursor.execute(query, params)
            unregistered_students = cursor.fetchall()

            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            for student in unregistered_students:
                students_tree.insert("", tk.END, values=student)

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
        load_students()

    def show_top_absence_statistics(self):
        """Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ø£ÙƒØ«Ø± ØºÙŠØ§Ø¨Ø§Ù‹ ÙˆØªØ£Ø®Ø±Ø§Ù‹ ÙˆØºÙŠØ§Ø¨Ø§Ù‹ Ø¨Ø¹Ø°Ø±"""
        stats_window = tk.Toplevel(self.root)
        stats_window.title("Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„ØªØ£Ø®ÙŠØ±")
        stats_window.geometry("900x650")
        stats_window.configure(bg=self.colors["light"])
        stats_window.transient(self.root)
        stats_window.grab_set()

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        x = (stats_window.winfo_screenwidth() - 900) // 2
        y = (stats_window.winfo_screenheight() - 650) // 2
        stats_window.geometry(f"900x650+{x}+{y}")

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        header_frame = tk.Frame(stats_window, bg=self.colors["primary"], padx=20, pady=15)
        header_frame.pack(fill=tk.X)

        header_label = tk.Label(
            header_frame,
            text="Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ§Ù„ØªØ£Ø®ÙŠØ±",
            font=("Tajawal", 18, "bold"),
            bg=self.colors["primary"],
            fg="white"
        )
        header_label.pack()

        # Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
        control_frame = tk.Frame(stats_window, bg=self.colors["light"], padx=20, pady=10)
        control_frame.pack(fill=tk.X)

        tk.Label(
            control_frame,
            text="Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¹Ø±Ø¶Ù‡Ù…:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        ).pack(side=tk.RIGHT, padx=5)

        limit_var = tk.StringVar(value="10")
        limit_combobox = ttk.Combobox(
            control_frame,
            textvariable=limit_var,
            values=["5", "10", "15", "20", "25", "50"],
            state="readonly",
            width=5,
            font=self.fonts["text"]
        )
        limit_combobox.pack(side=tk.RIGHT, padx=5)

        tk.Label(
            control_frame,
            text="ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø©:",
            font=self.fonts["text_bold"],
            bg=self.colors["light"]
        ).pack(side=tk.RIGHT, padx=5)

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙˆØ±Ø§Øª
        cursor = self.conn.cursor()
        cursor.execute("SELECT DISTINCT course FROM trainees WHERE course IS NOT NULL AND course != '' ORDER BY course")
        courses = ["Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª"] + [row[0] for row in cursor.fetchall()]

        course_var = tk.StringVar(value="Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª")
        course_combobox = ttk.Combobox(
            control_frame,
            textvariable=course_var,
            values=courses,
            state="readonly",
            width=20,
            font=self.fonts["text"]
        )
        course_combobox.pack(side=tk.RIGHT, padx=5)

        refresh_button = tk.Button(
            control_frame,
            text="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
            font=self.fonts["text_bold"],
            bg=self.colors["success"],
            fg="white",
            padx=10, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: load_statistics()
        )
        refresh_button.pack(side=tk.LEFT, padx=5)

        export_button = tk.Button(
            control_frame,
            text="ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª",
            font=self.fonts["text_bold"],
            bg=self.colors["secondary"],
            fg="white",
            padx=10, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=lambda: export_statistics()
        )
        export_button.pack(side=tk.LEFT, padx=5)

        # Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        tab_control = ttk.Notebook(stats_window)
        tab_control.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø©
        tab_absence = tk.Frame(tab_control, bg=self.colors["light"])
        tab_lateness = tk.Frame(tab_control, bg=self.colors["light"])
        tab_excused = tk.Frame(tab_control, bg=self.colors["light"])

        tab_control.add(tab_absence, text="Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨")
        tab_control.add(tab_lateness, text="Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØªØ£Ø®ÙŠØ±")
        tab_control.add(tab_excused, text="Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±")

        # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø±Ø¶
        absence_tree = self.create_stats_tree(tab_absence)
        lateness_tree = self.create_stats_tree(tab_lateness)
        excused_tree = self.create_stats_tree(tab_excused)

        # Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        def load_statistics():
            limit = int(limit_var.get())
            course_filter = course_var.get()

            # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            for tree in [absence_tree, lateness_tree, excused_tree]:
                for item in tree.get_children():
                    tree.delete(item)

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±Ø· Ø§Ù„Ø¯ÙˆØ±Ø©
            course_condition = ""
            course_params = []

            if course_filter != "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª":
                course_condition = "AND t.course = ?"
                course_params = [course_filter]

            # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨
            query_absence = f"""
            SELECT t.national_id, t.name, t.rank, t.course, COUNT(*) as count
            FROM attendance a
            JOIN trainees t ON a.national_id = t.national_id
            WHERE a.status = 'ØºØ§Ø¦Ø¨' AND t.is_excluded = 0 {course_condition}
            GROUP BY t.national_id
            ORDER BY count DESC
            LIMIT ?
            """

            # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ØªØ£Ø®ÙŠØ±
            query_lateness = f"""
            SELECT t.national_id, t.name, t.rank, t.course, COUNT(*) as count
            FROM attendance a
            JOIN trainees t ON a.national_id = t.national_id
            WHERE a.status = 'Ù…ØªØ£Ø®Ø±' AND t.is_excluded = 0 {course_condition}
            GROUP BY t.national_id
            ORDER BY count DESC
            LIMIT ?
            """

            # Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±
            query_excused = f"""
            SELECT t.national_id, t.name, t.rank, t.course, COUNT(*) as count
            FROM attendance a
            JOIN trainees t ON a.national_id = t.national_id
            WHERE a.status = 'ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±' AND t.is_excluded = 0 {course_condition}
            GROUP BY t.national_id
            ORDER BY count DESC
            LIMIT ?
            """

            # ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            cursor = self.conn.cursor()

            # Ø§Ù„ØºÙŠØ§Ø¨
            cursor.execute(query_absence, course_params + [limit])
            result_absence = cursor.fetchall()
            for i, row in enumerate(result_absence):
                national_id, name, rank, course, count = row
                absence_tree.insert("", tk.END, values=(i + 1, national_id, name, rank, course, count,
                                                        f"{(count / self.get_total_days(national_id) * 100):.1f}%"))

            # Ø§Ù„ØªØ£Ø®ÙŠØ±
            cursor.execute(query_lateness, course_params + [limit])
            result_lateness = cursor.fetchall()
            for i, row in enumerate(result_lateness):
                national_id, name, rank, course, count = row
                lateness_tree.insert("", tk.END, values=(i + 1, national_id, name, rank, course, count,
                                                         f"{(count / self.get_total_days(national_id) * 100):.1f}%"))

            # Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±
            cursor.execute(query_excused, course_params + [limit])
            result_excused = cursor.fetchall()
            for i, row in enumerate(result_excused):
                national_id, name, rank, course, count = row
                excused_tree.insert("", tk.END, values=(i + 1, national_id, name, rank, course, count,
                                                        f"{(count / self.get_total_days(national_id) * 100):.1f}%"))

        # Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        def export_statistics():
            if not self.current_user["permissions"]["can_export_data"]:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
                return

            limit = int(limit_var.get())
            course_filter = course_var.get()

            # Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù„Ù
            export_file = filedialog.asksaveasfilename(
                defaultextension=".xlsx",
                filetypes=[("Excel files", "*.xlsx")],
                initialfile=f"Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª_Ø§Ù„ØºÙŠØ§Ø¨_ÙˆØ§Ù„ØªØ£Ø®ÙŠØ±.xlsx"
            )

            if not export_file:
                return

            try:
                import pandas as pd
                from pandas import ExcelWriter

                # Ø¥Ø¹Ø¯Ø§Ø¯ Ø´Ø±Ø· Ø§Ù„Ø¯ÙˆØ±Ø© Ù„Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª
                course_condition = ""
                course_params = []

                if course_filter != "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª":
                    course_condition = "AND t.course = ?"
                    course_params = [course_filter]

                # Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                query_absence = f"""
                SELECT t.national_id, t.name, t.rank, t.course, COUNT(*) as count
                FROM attendance a
                JOIN trainees t ON a.national_id = t.national_id
                WHERE a.status = 'ØºØ§Ø¦Ø¨' AND t.is_excluded = 0 {course_condition}
                GROUP BY t.national_id
                ORDER BY count DESC
                LIMIT ?
                """

                query_lateness = f"""
                SELECT t.national_id, t.name, t.rank, t.course, COUNT(*) as count
                FROM attendance a
                JOIN trainees t ON a.national_id = t.national_id
                WHERE a.status = 'Ù…ØªØ£Ø®Ø±' AND t.is_excluded = 0 {course_condition}
                GROUP BY t.national_id
                ORDER BY count DESC
                LIMIT ?
                """

                query_excused = f"""
                SELECT t.national_id, t.name, t.rank, t.course, COUNT(*) as count
                FROM attendance a
                JOIN trainees t ON a.national_id = t.national_id
                WHERE a.status = 'ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±' AND t.is_excluded = 0 {course_condition}
                GROUP BY t.national_id
                ORDER BY count DESC
                LIMIT ?
                """

                cursor = self.conn.cursor()

                # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                cursor.execute(query_absence, course_params + [limit])
                absence_data = cursor.fetchall()

                cursor.execute(query_lateness, course_params + [limit])
                lateness_data = cursor.fetchall()

                cursor.execute(query_excused, course_params + [limit])
                excused_data = cursor.fetchall()

                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ DataFrame
                columns = ["Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø±ØªØ¨Ø©", "Ø§Ù„Ø¯ÙˆØ±Ø©", "Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨", "Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©"]

                # Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
                def add_percentage(data_list):
                    result = []
                    for row in data_list:
                        national_id, name, rank, course, count = row
                        total_days = self.get_total_days(national_id)
                        percentage = f"{(count / total_days * 100):.1f}%" if total_days > 0 else "0%"
                        result.append([national_id, name, rank, course, count, percentage])
                    return result

                df_absence = pd.DataFrame(add_percentage(absence_data), columns=columns)
                df_lateness = pd.DataFrame(add_percentage(lateness_data), columns=columns)
                df_excused = pd.DataFrame(add_percentage(excused_data), columns=columns)

                # ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Excel
                with ExcelWriter(export_file) as writer:
                    df_absence.to_excel(writer, sheet_name="Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨", index=False)
                    df_lateness.to_excel(writer, sheet_name="Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØªØ£Ø®ÙŠØ±", index=False)
                    df_excused.to_excel(writer, sheet_name="Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ù„Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±", index=False)

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰:\n{export_file}")

            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {str(e)}")

        # Ø²Ø± Ø§Ù„Ø¥ØºÙ„Ø§Ù‚
        close_button = tk.Button(
            stats_window,
            text="Ø¥ØºÙ„Ø§Ù‚",
            font=self.fonts["text_bold"],
            bg=self.colors["dark"],
            fg="white",
            padx=20, pady=5,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=stats_window.destroy
        )
        close_button.pack(pady=10)

        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø¯Ø¦ÙŠØ§Ù‹
        load_statistics()

    def create_stats_tree(self, parent_frame):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª"""
        # Ø¥Ù†Ø´Ø§Ø¡ Ø¥Ø·Ø§Ø± Ù„Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ Ø´Ø±ÙŠØ· ØªÙ…Ø±ÙŠØ±
        tree_frame = tk.Frame(parent_frame, bg=self.colors["light"])
        tree_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)

        scrollbar = tk.Scrollbar(tree_frame)
        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

        tree = ttk.Treeview(
            tree_frame,
            columns=("rank", "id", "name", "grade", "course", "count", "percentage"),
            show="headings",
            yscrollcommand=scrollbar.set,
            style="Bold.Treeview"
        )

        # ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        tree.column("rank", width=50, anchor=tk.CENTER)
        tree.column("id", width=120, anchor=tk.CENTER)
        tree.column("name", width=180, anchor=tk.CENTER)
        tree.column("grade", width=100, anchor=tk.CENTER)
        tree.column("course", width=150, anchor=tk.CENTER)
        tree.column("count", width=80, anchor=tk.CENTER)
        tree.column("percentage", width=100, anchor=tk.CENTER)

        # Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
        tree.heading("rank", text="Ø§Ù„ØªØ±ØªÙŠØ¨")
        tree.heading("id", text="Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©")
        tree.heading("name", text="Ø§Ù„Ø§Ø³Ù…")
        tree.heading("grade", text="Ø§Ù„Ø±ØªØ¨Ø©")
        tree.heading("course", text="Ø§Ù„Ø¯ÙˆØ±Ø©")
        tree.heading("count", text="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª")
        tree.heading("percentage", text="Ø§Ù„Ù†Ø³Ø¨Ø©")

        tree.pack(fill=tk.BOTH, expand=True)
        scrollbar.config(command=tree.yview)

        return tree

    def get_total_days(self, national_id):
        """Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ù„Ù„Ù…ØªØ¯Ø±Ø¨"""
        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT COUNT(DISTINCT date) 
            FROM attendance 
            WHERE national_id=?
        """, (national_id,))
        total = cursor.fetchone()[0]
        return total if total > 0 else 1  # Ù„ØªØ¬Ù†Ø¨ Ø§Ù„Ù‚Ø³Ù…Ø© Ø¹Ù„Ù‰ ØµÙØ±

    def export_based_on_filter(self):
        if not self.current_user["permissions"]["can_export_data"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return

        status_value = self.status_filter_var.get()
        if status_value == "Ø§Ù„ÙƒÙ„":
            self.export_filtered_records(None)
        else:
            self.export_filtered_records(status_value)

    def update_attendance_display(self):
        # ØªØ­Ø¯ÙŠØ¯ Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©
        self.page_size = 100  # Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„ÙˆØ§Ø­Ø¯Ø©
        self.current_page = 1 if not hasattr(self, 'current_page') else self.current_page

        # Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        for row in self.attendance_tree.get_children():
            self.attendance_tree.delete(row)

        date_str = self.log_date_entry.get_date().strftime("%Y-%m-%d")
        search_text = self.log_search_var.get().strip()
        status_filter_val = self.status_filter_var.get()

        # Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ù…Ø¹ ØªØµÙÙŠØ©
        query = """
            SELECT a.national_id, a.name, a.rank, a.course, a.status,
                   a.updated_by, a.updated_at
            FROM attendance a
            JOIN trainees t ON a.national_id = t.national_id
            WHERE a.date=? AND t.is_excluded=0
        """
        params = [date_str]

        # Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
        if status_filter_val != "Ø§Ù„ÙƒÙ„":
            query += " AND a.status=?"
            params.append(status_filter_val)

        # Ø¥Ø¶Ø§ÙØ© Ø´Ø±Ø· Ø§Ù„Ø¨Ø­Ø«
        if search_text:
            query += " AND (a.national_id LIKE ? OR a.name LIKE ?)"
            params.extend([f'%{search_text}%', f'%{search_text}%'])

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        count_query = f"SELECT COUNT(*) FROM ({query}) AS filtered_results"
        cursor = self.conn.cursor()
        cursor.execute(count_query, params)
        total_records = cursor.fetchone()[0]

        # ØªØ­Ø¯ÙŠØ¯ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª
        total_pages = max(1, (total_records + self.page_size - 1) // self.page_size)

        # Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ÙˆØ¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        limit_offset = f" LIMIT {self.page_size} OFFSET {(self.current_page - 1) * self.page_size}"
        query += limit_offset

        # ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…
        cursor.execute(query, params)
        results = cursor.fetchall()

        # Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        for row in results:
            national_id = row[0]

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨
            all_absences = self.get_all_absences_count(national_id)
            all_lates = self.get_all_late_count(national_id)
            all_excused = self.get_all_excused_count(national_id)

            # Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙ…Ø© checkbox ÙØ§Ø±ØºØ© ÙƒØ£ÙˆÙ„ Ø¹Ù†ØµØ±
            checkbox_value = ""
            values = [checkbox_value] + list(row[0:5]) + [all_absences, all_lates, all_excused]

            # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ±Ø­ Ù„Ù‡
            if self.current_user["permissions"]["can_view_edit_history"]:
                values.extend([row[5] if row[5] else "", row[6] if row[6] else ""])

            item_id = self.attendance_tree.insert("", tk.END, values=values)

            # ØªØ·Ø¨ÙŠÙ‚ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©
            status = row[4]
            self.apply_status_color(item_id, status)

        # Ø¥Ø¶Ø§ÙØ© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª
        self.create_pagination_controls(total_pages)


    def on_attendance_double_click(self, event=None):
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±")
            return

        item = self.attendance_tree.selection()
        if not item:
            return
        values = self.attendance_tree.item(item, "values")
        if not values:
            return

        national_id = values[1]
        date_str = self.log_date_entry.get_date().strftime("%Y-%m-%d")

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ø± Ø§Ù„Ø³Ø¬Ù„
        record_date = datetime.datetime.strptime(date_str, "%Y-%m-%d").date()
        today = datetime.datetime.now().date()
        days_diff = (today - record_date).days

        # Ø¥Ø°Ø§ Ù…Ø¶Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ…
        if days_diff > 0:
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
            can_edit_old = self.current_user["permissions"].get("can_edit_old_attendance", False)
            is_admin = self.current_user["username"] == "admin"

            # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† admin ÙˆÙ„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ©
            if not is_admin and not can_edit_old:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡",
                                       "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¶Ø§Ø¨Ø· Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ø£Ø®Ø° Ø§Ù„ØªÙˆØ¬ÙŠÙ‡")
                return

        attendance_id = self.get_attendance_record_id(national_id, date_str)
        if not attendance_id:
            messagebox.showinfo("Ø®Ø·Ø£", "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­Ø¯Ø¯.")
            return
        self.open_edit_attendance_window(attendance_id, values)

    def get_attendance_record_id(self, national_id, date_str):
        cursor = self.conn.cursor()
        cursor.execute("SELECT id FROM attendance WHERE national_id=? AND date=?", (national_id, date_str))
        result = cursor.fetchone()
        return result[0] if result else None

    # ØªØ¹Ø¯ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù„Ø¯Ø§Ù„Ø© open_edit_attendance_window
    def open_edit_attendance_window(self, attendance_id, row_values):
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ±")
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ù„Ù„Ù…ØªØ¯Ø±Ø¨
        cursor = self.conn.cursor()
        cursor.execute("SELECT original_status FROM attendance WHERE id=?", (attendance_id,))
        original_status = cursor.fetchone()[0]

        edit_window = tk.Toplevel(self.root)
        edit_window.title("ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±")
        edit_window.geometry("500x450")
        edit_window.configure(bg=self.colors["light"])
        edit_window.transient(self.root)
        edit_window.grab_set()

        x = (edit_window.winfo_screenwidth() - 500) // 2
        y = (edit_window.winfo_screenheight() - 450) // 2
        edit_window.geometry(f"500x450+{x}+{y}")

        tk.Label(edit_window, text="ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ±", font=self.fonts["title"], bg=self.colors["primary"],
                 fg="white", padx=10, pady=10, width=500).pack(fill=tk.X)

        info_frame = tk.Frame(edit_window, bg=self.colors["light"], padx=20, pady=10)
        info_frame.pack(fill=tk.X)

        tk.Label(info_frame, text=f"Ø§Ù„Ù…ØªØ¯Ø±Ø¨: {row_values[2]}", font=self.fonts["text_bold"],
                 bg=self.colors["light"]).pack(anchor=tk.W)

        tk.Label(info_frame, text=f"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: {row_values[5]}", font=self.fonts["text"],
                 bg=self.colors["light"]).pack(anchor=tk.W)

        tk.Label(info_frame, text=f"Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©: {original_status}", font=self.fonts["text"],
                 bg=self.colors["light"]).pack(anchor=tk.W)

        new_status_frame = tk.LabelFrame(edit_window, text="Ø§Ø®ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©", font=self.fonts["text_bold"],
                                         bg=self.colors["light"], fg=self.colors["dark"], padx=10, pady=10)
        new_status_frame.pack(fill=tk.X, padx=20, pady=10)

        status_options = ["Ø­Ø§Ø¶Ø±", "Ù…ØªØ£Ø®Ø±", "ØºØ§Ø¦Ø¨", "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±", "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±", "Ø­Ø§Ù„Ø© ÙˆÙØ§Ø©", "Ù…Ù†ÙˆÙ…"]
        status_var = tk.StringVar(value=row_values[5])

        status_combobox = ttk.Combobox(new_status_frame, textvariable=status_var, values=status_options,
                                       state="readonly", font=self.fonts["text"])
        status_combobox.pack(fill=tk.X, padx=5, pady=5)

        # Ø¥Ø·Ø§Ø± Ø£Ø³Ø¨Ø§Ø¨ Ø§Ù„ØºÙŠØ§Ø¨
        reason_frame = tk.Frame(edit_window, bg=self.colors["light"], padx=20, pady=5)
        reason_frame.pack(fill=tk.X)

        reason_label = tk.Label(reason_frame, text="Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨:", font=self.fonts["text"], bg=self.colors["light"])
        reason_entry = tk.Entry(reason_frame, font=self.fonts["text"], width=40)

        # Ø¥Ø·Ø§Ø± Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        mod_reason_frame = tk.Frame(edit_window, bg=self.colors["light"], padx=20, pady=5)
        mod_reason_frame.pack(fill=tk.X)

        mod_reason_label = tk.Label(mod_reason_frame, text="Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„:", font=self.fonts["text"],
                                    bg=self.colors["light"])
        mod_reason_entry = tk.Entry(mod_reason_frame, font=self.fonts["text"], width=40)

        def on_status_change(*args):
            # Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØºÙŠØ§Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±"
            if status_var.get() == "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±":
                reason_label.pack(anchor=tk.W)
                reason_entry.pack(fill=tk.X, pady=5)
            else:
                reason_label.pack_forget()
                reason_entry.pack_forget()

            # Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø³Ø¨Ø¨ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø®ØªÙ„ÙØ© Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
            if status_var.get() != original_status:
                mod_reason_label.pack(anchor=tk.W)
                mod_reason_entry.pack(fill=tk.X, pady=5)
            else:
                mod_reason_label.pack_forget()
                mod_reason_entry.pack_forget()

        status_var.trace("w", on_status_change)
        on_status_change()

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        button_frame = tk.Frame(edit_window, bg=self.colors["light"], pady=10)
        button_frame.pack(fill=tk.X, padx=20)

        def save_changes():
            new_status = status_var.get()
            new_reason = reason_entry.get().strip() if new_status == "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±" else ""
            modification_reason = mod_reason_entry.get().strip() if new_status != original_status else ""

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ù…Ø± Ø§Ù„Ø³Ø¬Ù„
            date_str = self.log_date_entry.get_date().strftime("%Y-%m-%d")
            record_date = datetime.datetime.strptime(date_str, "%Y-%m-%d").date()
            today = datetime.datetime.now().date()
            days_diff = (today - record_date).days

            # Ø¥Ø°Ø§ Ù…Ø¶Ù‰ Ø£ÙƒØ«Ø± Ù…Ù† ÙŠÙˆÙ… ÙˆÙ„ÙŠØ³ Ù„Ø¯ÙŠÙ‡ ØµÙ„Ø§Ø­ÙŠØ© Ø®Ø§ØµØ©
            if days_diff > 0:
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                has_permission = (
                        self.current_user["username"] == "admin" or
                        self.current_user["permissions"].get("can_edit_old_attendance", False) == True
                )

                if not has_permission:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡",
                                           "Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨\nØ§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¶Ø§Ø¨Ø· Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ù„Ø£Ø®Ø° Ø§Ù„ØªÙˆØ¬ÙŠÙ‡")
                    return

            now_str = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆÙ‚ÙŠÙ…Ø© receiver_name Ø§Ù„Ø­Ø§Ù„ÙŠØ©
            cursor.execute("SELECT status, receiver_name FROM attendance WHERE id=?", (attendance_id,))
            result = cursor.fetchone()
            old_status = result[0]
            old_receiver = result[1] if result[1] else ""

            # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
            new_receiver_name = old_receiver

            # Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±" ÙˆØ§Ù„Ø¬Ø¯ÙŠØ¯Ø© "Ø­Ø§Ø¶Ø±" Ø£Ùˆ "Ù…ØªØ£Ø®Ø±"
            if old_status == "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±" and new_status in ["Ø­Ø§Ø¶Ø±", "Ù…ØªØ£Ø®Ø±"]:
                receiver_name = self.get_receiver_name(row_values[2])  # row_values[2] Ù‡Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…ØªØ¯Ø±Ø¨
                if not receiver_name:
                    return
                new_receiver_name = receiver_name

            try:
                with self.conn:
                    self.conn.execute("""
                        UPDATE attendance
                        SET status=?, excuse_reason=?,
                            updated_by=?, updated_at=?, modification_reason=?,
                            receiver_name=?
                        WHERE id=?
                    """, (
                        new_status,
                        new_reason,
                        self.current_user["full_name"],
                        now_str,
                        modification_reason,
                        new_receiver_name,
                        attendance_id
                    ))

                    # ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                    if days_diff > 0:
                        self.conn.execute("""
                            INSERT INTO historical_edits_log (
                                attendance_id, national_id, student_name, edit_date, 
                                original_date, old_status, new_status, edited_by, 
                                edit_timestamp, days_difference
                            ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        """, (
                            attendance_id,
                            row_values[1],  # national_id
                            row_values[2],  # student_name
                            datetime.datetime.now().strftime("%Y-%m-%d"),
                            date_str,
                            old_status,
                            new_status,
                            self.current_user["full_name"],
                            now_str,
                            days_diff
                        ))

                messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­")
                edit_window.destroy()
                self.update_attendance_display()
                self.update_statistics()
            except Exception as e:
                messagebox.showerror("Ø®Ø·Ø£", str(e))

        def delete_record():
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‡Ùˆ admin ÙÙ‚Ø·
            if self.current_user["username"] != "admin":
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„.. ÙŠØ¬Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„ØªÙ‡ ÙÙ‚Ø·")
                return

            if messagebox.askyesno("ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù",
                                   f"Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ {row_values[2]} Ù„ÙŠÙˆÙ… {self.log_date_entry.get_date().strftime('%Y-%m-%d')}ØŸ\n\nÙ„Ù† ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨."):
                try:
                    with self.conn:
                        self.conn.execute("DELETE FROM attendance WHERE id=?", (attendance_id,))
                    messagebox.showinfo("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø­Ø°Ù ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ø¨Ù†Ø¬Ø§Ø­")
                    edit_window.destroy()
                    self.update_attendance_display()
                    self.update_statistics()
                except Exception as e:
                    messagebox.showerror("Ø®Ø·Ø£", str(e))

        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        save_btn = tk.Button(button_frame, text="Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª", font=self.fonts["text_bold"],
                             bg=self.colors["success"], fg="white", padx=15, pady=5, bd=0,
                             relief=tk.FLAT, cursor="hand2", command=save_changes)
        save_btn.pack(side=tk.LEFT, padx=5)

        delete_btn = tk.Button(button_frame, text="Ø­Ø°Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„", font=self.fonts["text_bold"],
                               bg="#FF5722", fg="white", padx=15, pady=5, bd=0,
                               relief=tk.FLAT, cursor="hand2", command=delete_record)
        delete_btn.pack(side=tk.LEFT, padx=5)

        cancel_btn = tk.Button(button_frame, text="Ø¥Ù„ØºØ§Ø¡", font=self.fonts["text_bold"],
                               bg=self.colors["danger"], fg="white", padx=15, pady=5, bd=0,
                               relief=tk.FLAT, cursor="hand2", command=edit_window.destroy)
        cancel_btn.pack(side=tk.RIGHT, padx=5)

            def insert_attendance_record(self, status, excuse_reason=""):
        """Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨")
            return

        national_id = self.id_entry.get().strip()
        if not national_id:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¯Ø±Ø¨ Ù…Ù† Ø®Ù„Ø§Ù„ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡ÙˆÙŠØ©")
            return

        cursor = self.conn.cursor()
        cursor.execute("""
            SELECT national_id, name, rank, course, is_excluded 
            FROM trainees 
            WHERE national_id=?
        """, (national_id,))

        trainee = cursor.fetchone()
        if not trainee:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¯Ø±Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…")
            return

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨
        if trainee[4] == 1:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù…Ø³ØªØ¨Ø¹Ø¯ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ù‡")
            return

        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?", (trainee[0], current_date))
        existing_record = cursor.fetchone()

        if existing_record:
            existing_status = existing_record[0]

            # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù†ÙˆØ§ÙØ° Ø®Ø·Ø£ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¬Ø°Ø¨ Ø§Ù†ØªØ¨Ø§Ù‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if existing_status == status:
                # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†ÙØ³ Ø§Ù„Ø­Ø§Ù„Ø©
                messagebox.showerror("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙƒØ±Ø§Ø±",
                                     f"âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ù…ØªØ¯Ø±Ø¨ {trainee[1]} Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø­Ø§Ù„Ø© '{existing_status}' Ø§Ù„ÙŠÙˆÙ…\n\nÙ„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ø­Ø§Ù„Ø© Ù„Ù„Ù…ØªØ¯Ø±Ø¨ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ….")
            else:
                # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø­Ø§Ù„Ø© Ù…Ø®ØªÙ„ÙØ©
                messagebox.showerror("ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø©",
                                     f"âš ï¸ ØªÙ†Ø¨Ù€Ù€Ù€ÙŠÙ‡: Ø§Ù„Ù…ØªØ¯Ø±Ø¨ {trainee[1]} Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¨Ø­Ø§Ù„Ø© '{existing_status}' Ø§Ù„ÙŠÙˆÙ…\n\nÙ„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† '{existing_status}' Ø¥Ù„Ù‰ '{status}'ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø§ØµÙŠØ© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±.")

            # Ù…Ø³Ø­ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‡ÙˆÙŠØ©
            self.id_entry.delete(0, tk.END)
            self.name_search_entry.delete(0, tk.END)
            return

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¨Ù‚
        current_date_obj = self.date_entry.get_date()
        yesterday_date_obj = current_date_obj - datetime.timedelta(days=1)
        yesterday_date = yesterday_date_obj.strftime("%Y-%m-%d")

        cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?", (trainee[0], yesterday_date))
        yesterday_record = cursor.fetchone()

        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
        receiver_name = ""

        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
        if yesterday_record and yesterday_record[0] == "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±":
            if status in ["Ø­Ø§Ø¶Ø±", "Ù…ØªØ£Ø®Ø±"]:
                # Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙƒØ§Ù† "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±" Ø¨Ø§Ù„Ø£Ù…Ø³ ÙˆØ§Ù„ÙŠÙˆÙ… "Ø­Ø§Ø¶Ø±" Ø£Ùˆ "Ù…ØªØ£Ø®Ø±" - ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„
                receiver_name = self.get_receiver_name(trainee[1])
                if not receiver_name:
                    # Ø¥Ø°Ø§ Ø£Ù„ØºÙ‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ù„Ù… ÙŠØ¯Ø®Ù„ Ø§Ø³Ù…ØŒ Ù†ÙˆÙ‚Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                    return
            elif status == "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±":
                # Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙƒØ§Ù† "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±" Ø¨Ø§Ù„Ø£Ù…Ø³ ÙˆØ§Ù„ÙŠÙˆÙ… Ø£ÙŠØ¶Ø§Ù‹ "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±" - Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¯ÙˆÙ† ØªÙ†Ø¨ÙŠÙ‡
                pass  # Ù„Ø§ Ù†ÙØ¹Ù„ Ø´ÙŠØ¡ØŒ Ù†ÙƒÙ…Ù„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø´ÙƒÙ„ Ø·Ø¨ÙŠØ¹ÙŠ
            elif status == "ØºØ§Ø¦Ø¨":
                # Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙƒØ§Ù† "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±" Ø¨Ø§Ù„Ø£Ù…Ø³ ÙˆØ§Ù„ÙŠÙˆÙ… "ØºØ§Ø¦Ø¨" - Ù†Ù…Ù†Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
                messagebox.showerror("Ø®Ø·Ø£",
                                     f"Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ {trainee[1]} ÙƒÙ€ 'ØºØ§Ø¦Ø¨'\n\n"
                                     "Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' Ø¨Ø§Ù„Ø£Ù…Ø³.\n"
                                     "ØªØ³Ø¬ÙŠÙ„Ù‡ ÙƒÙ€ 'ØºØ§Ø¦Ø¨' Ù…Ø®Ø§Ù„Ù Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø³ØªØ¯ÙŠÙ…Ø©."
                                     )
                # Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
                self.id_entry.delete(0, tk.END)
                self.name_search_entry.delete(0, tk.END)
                self.name_listbox.delete(0, tk.END)
                return

        t_id, t_name, t_rank, t_course, _ = trainee
        current_time = datetime.datetime.now().strftime("%H:%M:%S")

        # Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„ØºÙŠØ§Ø¨ ÙˆØ±ØµØ¯ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±
        absence_alert = False
        alert_message = ""
        alert_type = None
        alert_color = None

        if status in ["ØºØ§Ø¦Ø¨"]:
            absence_alert, alert_message, alert_type, alert_color = self.check_student_absence(t_id, current_date)

        try:
            # Ø§Ø³ØªØ®Ø¯Ø§Ù… cursor Ù…Ù†ÙØµÙ„ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ lastrowid
            cursor = self.conn.cursor()

            cursor.execute("""
                INSERT INTO attendance (
                    national_id, name, rank, course,
                    time, date, status, original_status,
                    registered_by, excuse_reason,
                    updated_by, updated_at, receiver_name
                )
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            """, (
                t_id, t_name, t_rank, t_course,
                current_time, current_date,
                status, status,
                self.current_user["full_name"], excuse_reason,
                "", "", receiver_name
            ))

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¶Ø§Ù
            attendance_id = cursor.lastrowid

            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† commit Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            self.conn.commit()

            # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ø¬Ù„ Ù„Ù„ØªØ±Ø§Ø¬Ø¹
            self.session_attendance_history.append({
                'id': attendance_id,
                'national_id': t_id,
                'name': t_name,
                'course': t_course,
                'status': status,
                'date': current_date,
                'time': current_time
            })

            # ØªØ­Ø¯ÙŠØ« Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ£ÙƒÙŠØ¯ ÙÙŠ Ø¹Ù†ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
            if status == "Ø­Ø§Ø¶Ø±":
                icon_status = "âœ…"
            elif status == "ØºØ§Ø¦Ø¨":
                icon_status = "âŒ"
            elif status == "Ù…ØªØ£Ø®Ø±":
                icon_status = "â°"
            elif status == "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±":
                icon_status = "ğŸ“"
            elif status == "Ù„Ù… ÙŠØ¨Ø§Ø´Ø±":
                icon_status = "â³"
            elif status == "Ø­Ø§Ù„Ø© ÙˆÙØ§Ø©":
                icon_status = "ğŸ’”"
            elif status == "Ù…Ù†ÙˆÙ…":
                icon_status = "ğŸ¥"
            else:
                icon_status = "ğŸ“Œ"

            # Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø· ÙÙŠ Ø­Ù‚Ù„ Ø¢Ø®Ø± Ù…ØªØ¯Ø±Ø¨ Ø³ÙØ¬Ù‘Ù„ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø©
            self.last_registered_label.config(text=f"Ø¢Ø®Ø± Ù…ØªØ¯Ø±Ø¨ Ø³ÙØ¬ÙÙ‘Ù„: {t_name} ({status}) {icon_status}")

            # Ù…Ø³Ø­ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
            self.id_entry.delete(0, tk.END)
            self.name_search_entry.delete(0, tk.END)
            self.name_listbox.delete(0, tk.END)

            self.update_statistics()
            self.update_attendance_display()

            # Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø·Ù„ÙˆØ¨Ù‹Ø§
            if absence_alert:
                self.show_absence_alert(alert_message, alert_type, alert_color)

        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", str(e))

    # 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ (ÙƒÙ…Ø§ Ù‡ÙŠ)
    def get_receiver_name(self, student_name):
        """Ù†Ø§ÙØ°Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ - Ù…Ø­Ø¯Ø«Ø© Ø¨Ø­Ø¬Ù… Ø£ÙƒØ¨Ø±"""
        receiver_window = tk.Toplevel(self.root)
        receiver_window.title("Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨")
        receiver_window.geometry("550x450")  # ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù†Ø§ÙØ°Ø©
        receiver_window.configure(bg=self.colors["light"])
        receiver_window.transient(self.root)
        receiver_window.grab_set()

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        x = (receiver_window.winfo_screenwidth() - 550) // 2
        y = (receiver_window.winfo_screenheight() - 450) // 2
        receiver_window.geometry(f"550x450+{x}+{y}")

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©
        tk.Label(
            receiver_window,
            text="ØµØ§Ø­Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ù…ØªØ¯Ø±Ø¨",
            font=("Tajawal", 20, "bold"),  # Ø®Ø· Ø£ÙƒØ¨Ø±
            bg=self.colors["primary"],
            fg="white",
            padx=15, pady=15
        ).pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        content_frame = tk.Frame(receiver_window, bg=self.colors["light"], padx=30, pady=30)
        content_frame.pack(fill=tk.BOTH, expand=True)

        tk.Label(
            content_frame,
            text=f"Ø§Ù„Ù…ØªØ¯Ø±Ø¨: {student_name}",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["light"],
            fg=self.colors["primary"]
        ).pack(pady=(0, 5))

        tk.Label(
            content_frame,
            text="ÙƒØ§Ù† ÙÙŠ Ø­Ø§Ù„Ø© 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' Ø¨Ø§Ù„Ø£Ù…Ø³",
            font=("Tajawal", 12),
            bg=self.colors["light"]
        ).pack(pady=(0, 15))

        tk.Label(
            content_frame,
            text="Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø°ÙŠ Ø§Ø³ØªÙ‚Ø¨Ù„Ù‡:",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["light"],
            fg=self.colors["danger"]
        ).pack(pady=(0, 15))

        receiver_var = tk.StringVar()
        receiver_entry = tk.Entry(
            content_frame,
            textvariable=receiver_var,
            font=("Tajawal", 14),  # Ø®Ø· Ø£ÙƒØ¨Ø±
            width=35,
            bd=2,
            relief=tk.GROOVE
        )
        receiver_entry.pack(pady=5)
        receiver_entry.focus_set()

        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        result = [None]

        def save_receiver():
            name = receiver_var.get().strip()
            if not name:
                messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„")
                receiver_entry.focus_set()
                return
            result[0] = name
            receiver_window.destroy()

        def on_enter(event):
            save_receiver()

        receiver_entry.bind("<Return>", on_enter)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        button_frame = tk.Frame(receiver_window, bg=self.colors["light"], pady=15)
        button_frame.pack(fill=tk.X, padx=30)

        save_btn = tk.Button(
            button_frame,
            text="Ø­ÙØ¸",
            font=("Tajawal", 12, "bold"),
            bg=self.colors["success"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=save_receiver
        )
        save_btn.pack(side=tk.LEFT, padx=10)

        cancel_btn = tk.Button(
            button_frame,
            text="Ø¥Ù„ØºØ§Ø¡",
            font=("Tajawal", 12, "bold"),
            bg=self.colors["danger"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=receiver_window.destroy
        )
        cancel_btn.pack(side=tk.RIGHT, padx=10)

        # Ø§Ù†ØªØ¸Ø§Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
        receiver_window.wait_window()

        return result[0]

    # 1. Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù„Ù„ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠ
    def get_bulk_receivers_for_not_started(self, not_started_students, course_name):
        """Ù†Ø§ÙØ°Ø© Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ† Ù„Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø§Ù„Ø°ÙŠÙ† ÙƒØ§Ù†ÙˆØ§ 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' Ø¨Ø§Ù„Ø£Ù…Ø³"""
        if not not_started_students:
            return {}

        receivers_window = tk.Toplevel(self.root)
        receivers_window.title("Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†")
        receivers_window.geometry("700x600")
        receivers_window.configure(bg=self.colors["light"])
        receivers_window.transient(self.root)
        receivers_window.grab_set()

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        x = (receivers_window.winfo_screenwidth() - 700) // 2
        y = (receivers_window.winfo_screenheight() - 600) // 2
        receivers_window.geometry(f"700x600+{x}+{y}")

        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø§ÙØ°Ø©
        tk.Label(
            receivers_window,
            text=f"Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙÙŠ Ø¯ÙˆØ±Ø©: {course_name}",
            font=("Tajawal", 18, "bold"),
            bg=self.colors["primary"],
            fg="white",
            padx=15, pady=15
        ).pack(fill=tk.X)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        main_frame = tk.Frame(receivers_window, bg=self.colors["light"])
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

        tk.Label(
            main_frame,
            text=f"ÙŠÙˆØ¬Ø¯ {len(not_started_students)} Ù…ØªØ¯Ø±Ø¨ ÙƒØ§Ù†ÙˆØ§ ÙÙŠ Ø­Ø§Ù„Ø© 'Ù„Ù… ÙŠØ¨Ø§Ø´Ø±' Ø¨Ø§Ù„Ø£Ù…Ø³",
            font=("Tajawal", 14, "bold"),
            bg=self.colors["light"],
            fg=self.colors["danger"]
        ).pack(pady=(0, 10))

        # Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        input_type_var = tk.StringVar(value="same")

        options_frame = tk.Frame(main_frame, bg=self.colors["light"])
        options_frame.pack(fill=tk.X, pady=10)

        tk.Radiobutton(
            options_frame,
            text="Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†",
            variable=input_type_var,
            value="same",
            font=("Tajawal", 12),
            bg=self.colors["light"]
        ).pack(anchor=tk.W)

        tk.Radiobutton(
            options_frame,
            text="Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ù…ØªØ¯Ø±Ø¨",
            variable=input_type_var,
            value="different",
            font=("Tajawal", 12),
            bg=self.colors["light"]
        ).pack(anchor=tk.W)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯
        same_receiver_frame = tk.Frame(main_frame, bg=self.colors["light"])
        same_receiver_frame.pack(fill=tk.X, pady=10)

        tk.Label(
            same_receiver_frame,
            text="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„:",
            font=("Tajawal", 12, "bold"),
            bg=self.colors["light"]
        ).pack(anchor=tk.W)

        same_receiver_var = tk.StringVar()
        same_receiver_entry = tk.Entry(
            same_receiver_frame,
            textvariable=same_receiver_var,
            font=("Tajawal", 12),
            width=40
        )
        same_receiver_entry.pack(fill=tk.X, pady=5)

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯
        different_receivers_frame = tk.Frame(main_frame, bg=self.colors["light"])

        # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
        canvas = tk.Canvas(different_receivers_frame, bg=self.colors["light"])
        scrollbar = tk.Scrollbar(different_receivers_frame, orient="vertical", command=canvas.yview)
        scrollable_frame = tk.Frame(canvas, bg=self.colors["light"])

        scrollable_frame.bind(
            "<Configure>",
            lambda e: canvas.configure(scrollregion=canvas.bbox("all"))
        )

        canvas.create_window((0, 0), window=scrollable_frame, anchor="nw")
        canvas.configure(yscrollcommand=scrollbar.set)

        # Ù‚Ø§Ù…ÙˆØ³ Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        receiver_entries = {}

        # Ø¥Ù†Ø´Ø§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ÙƒÙ„ Ù…ØªØ¯Ø±Ø¨
        for student in not_started_students:
            student_frame = tk.Frame(scrollable_frame, bg=self.colors["light"], pady=5)
            student_frame.pack(fill=tk.X, padx=5)

            tk.Label(
                student_frame,
                text=f"{student['name']} ({student['national_id']})",
                font=("Tajawal", 10),
                bg=self.colors["light"],
                width=30,
                anchor=tk.W
            ).pack(side=tk.LEFT, padx=5)

            receiver_var = tk.StringVar()
            receiver_entry = tk.Entry(
                student_frame,
                textvariable=receiver_var,
                font=("Tajawal", 10),
                width=30
            )
            receiver_entry.pack(side=tk.LEFT, padx=5)

            receiver_entries[student['national_id']] = receiver_var

        canvas.pack(side="left", fill="both", expand=True)
        scrollbar.pack(side="right", fill="y")

        # Ø¯Ø§Ù„Ø© Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø·Ø§Ø±Ø§Øª
        def toggle_frames(*args):
            if input_type_var.get() == "same":
                different_receivers_frame.pack_forget()
                same_receiver_frame.pack(fill=tk.X, pady=10)
                same_receiver_entry.focus_set()
            else:
                same_receiver_frame.pack_forget()
                different_receivers_frame.pack(fill=tk.BOTH, expand=True, pady=10)

        input_type_var.trace("w", toggle_frames)
        toggle_frames()

        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        result = [None]

        def save_receivers():
            receivers_dict = {}

            if input_type_var.get() == "same":
                receiver_name = same_receiver_var.get().strip()
                if not receiver_name:
                    messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„")
                    return

                # Ù†ÙØ³ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†
                for student in not_started_students:
                    receivers_dict[student['national_id']] = receiver_name
            else:
                # Ù…Ø³ØªÙ‚Ø¨Ù„ Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ù…ØªØ¯Ø±Ø¨
                for student_id, receiver_var in receiver_entries.items():
                    receiver_name = receiver_var.get().strip()
                    if not receiver_name:
                        messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†")
                        return
                    receivers_dict[student_id] = receiver_name

            result[0] = receivers_dict
            receivers_window.destroy()

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        button_frame = tk.Frame(receivers_window, bg=self.colors["light"], pady=15)
        button_frame.pack(fill=tk.X, padx=20)

        save_btn = tk.Button(
            button_frame,
            text="Ø­ÙØ¸",
            font=("Tajawal", 12, "bold"),
            bg=self.colors["success"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=save_receivers
        )
        save_btn.pack(side=tk.LEFT, padx=10)

        cancel_btn = tk.Button(
            button_frame,
            text="Ø¥Ù„ØºØ§Ø¡",
            font=("Tajawal", 12, "bold"),
            bg=self.colors["danger"],
            fg="white",
            padx=20, pady=8,
            bd=0, relief=tk.FLAT,
            cursor="hand2",
            command=receivers_window.destroy
        )
        cancel_btn.pack(side=tk.RIGHT, padx=10)

        receivers_window.wait_window()

        return result[0]

    def show_absence_alert(self, message, alert_type, alert_color):
        """Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù…Ø®ØµØµØ© Ù„Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±"""
        alert_window = tk.Toplevel(self.root)
        alert_window.title(f"ØªÙ†Ø¨ÙŠÙ‡ ØºÙŠØ§Ø¨ Ù…ØªÙƒØ±Ø± - {alert_type}")
        alert_window.geometry("650x500")  # Ù†Ø§ÙØ°Ø© Ø£ÙƒØ¨Ø±
        alert_window.configure(bg="#FFFFFF")
        alert_window.transient(self.root)
        alert_window.grab_set()

        # ØªÙˆØ³ÙŠØ· Ø§Ù„Ù†Ø§ÙØ°Ø©
        x = (alert_window.winfo_screenwidth() - 650) // 2
        y = (alert_window.winfo_screenheight() - 500) // 2
        alert_window.geometry(f"650x500+{x}+{y}")

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        title_frame = tk.Frame(alert_window, bg=alert_color, padx=10, pady=15)
        title_frame.pack(fill=tk.X)

        title_label = tk.Label(
            title_frame,
            text="âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ ØºÙŠØ§Ø¨ Ù…ØªÙƒØ±Ø± âš ï¸",
            font=("Tajawal", 20, "bold"),  # Ø®Ø· Ø£ÙƒØ¨Ø± ÙˆØºØ§Ù…Ù‚
            bg=alert_color,
            fg="white"
        )
        title_label.pack()

        # Ø¥Ø·Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©
        message_frame = tk.Frame(alert_window, bg="#FFFFFF", padx=20, pady=20)
        message_frame.pack(fill=tk.BOTH, expand=True)

        message_text = tk.Text(
            message_frame,
            wrap=tk.WORD,
            bg="#FFFFFF",
            font=("Tajawal", 16, "bold"),  # Ø®Ø· Ø£ÙƒØ¨Ø± ÙˆØºØ§Ù…Ù‚
            relief=tk.FLAT,
            height=8
        )
        message_text.insert(tk.END, message)
        message_text.configure(state="disabled")  # Ø¬Ø¹Ù„ Ø§Ù„Ù†Øµ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© ÙÙ‚Ø·
        message_text.pack(fill=tk.BOTH, expand=True)

        # Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        button_frame = tk.Frame(alert_window, bg="#FFFFFF", padx=20, pady=15)
        button_frame.pack(fill=tk.X)

        ok_button = tk.Button(
            button_frame,
            text="Ù…ÙˆØ§ÙÙ‚",
            font=("Tajawal", 14, "bold"),  # Ø®Ø· Ø£ÙƒØ¨Ø±
            bg="#4CAF50",
            fg="white",
            padx=25,  # Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ø²Ø±
            pady=8,
            bd=0,
            relief=tk.FLAT,
            cursor="hand2",
            command=alert_window.destroy
        )
        ok_button.pack(side=tk.RIGHT, padx=10)

        # Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø®Ø§Øµ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù† Ø§Ù„Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·ÙŠØ±
        if alert_type == "Ø®Ø·ÙŠØ±":
            action_button = tk.Button(
                button_frame,
                text="Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡",
                font=("Tajawal", 14, "bold"),  # Ø®Ø· Ø£ÙƒØ¨Ø±
                bg="#FF5722",
                fg="white",
                padx=25,  # Ø²ÙŠØ§Ø¯Ø© Ø­Ø¬Ù… Ø§Ù„Ø²Ø±
                pady=8,
                bd=0,
                relief=tk.FLAT,
                cursor="hand2",
                command=lambda: self.take_absence_action(alert_window)
            )
            action_button.pack(side=tk.LEFT, padx=10)

    def take_absence_action(self, parent_window=None):
        """Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø§ØªØ®Ø§Ø° Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±"""
        # Ù†Ø§ÙØ°Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        messagebox.showinfo(
            "Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØºÙŠØ§Ø¨",
            "Ù„Ø§ ÙŠØ²Ø§Ù„ Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±\n\n"
            "Ù…Ù„Ø§Ø­Ø¸Ø©: ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¥Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ùˆ ØªØµØ¯ÙŠØ± Ù…Ø­Ø§Ø¶Ø± ØºÙŠØ§Ø¨Ù‡"
        )

        # Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
        if parent_window:
            parent_window.destroy()

    def process_barcode_ids(self, status):
        """ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù„Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±"""
        if not self.current_user["permissions"]["can_edit_attendance"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨")
            return

        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†Øµ Ù…Ù† Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
        barcode_text = self.barcode_text.get(1.0, tk.END).strip()
        if not barcode_text:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ§Øª Ø£ÙˆÙ„Ø§Ù‹")
            return

        # ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ø£Ø³Ø·Ø± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ§Øª
        id_lines = [line.strip() for line in barcode_text.split("\n") if line.strip()]
        if not id_lines:
            messagebox.showinfo("ØªÙ†Ø¨ÙŠÙ‡", "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… Ù‡ÙˆÙŠØ§Øª ØµØ§Ù„Ø­Ø©")
            return

        # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„
        current_date = self.date_entry.get_date().strftime("%Y-%m-%d")
        current_time = datetime.datetime.now().strftime("%H:%M:%S")

        cursor = self.conn.cursor()

        # Ù‚ÙˆØ§Ø¦Ù… Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        successful_ids = []
        failed_ids = []
        already_registered_ids = []
        excluded_ids = []
        absence_alerts = []  # Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø±

        # Ù…Ø¹Ø§Ù„Ø¬Ø© ÙƒÙ„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©
        for national_id in id_lines:
            # ØªØ®Ø·ÙŠ Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„ÙØ§Ø±ØºØ©
            if not national_id:
                continue

            try:
                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ ÙˆÙ…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³ØªØ¨Ø¹Ø¯Ù‹Ø§
                cursor.execute("""
                    SELECT national_id, name, rank, course, is_excluded 
                    FROM trainees 
                    WHERE national_id=?
                """, (national_id,))

                trainee = cursor.fetchone()
                if not trainee:
                    failed_ids.append(national_id)
                    continue

                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨
                if trainee[4] == 1:
                    excluded_ids.append(national_id)
                    continue

                # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù…Ø³Ø¬Ù„Ø§Ù‹ Ø¨Ø§Ù„ÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
                cursor.execute("SELECT status FROM attendance WHERE national_id=? AND date=?",
                               (trainee[0], current_date))
                existing_record = cursor.fetchone()

                if existing_record:
                    already_registered_ids.append(national_id)
                    continue

                # ÙØ­Øµ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ØºÙŠØ§Ø¨Ù‹Ø§
                if status == "ØºØ§Ø¦Ø¨":
                    absence_alert, alert_message, alert_type, alert_color = self.check_student_absence(trainee[0],
                                                                                                       current_date)
                    if absence_alert:
                        absence_alerts.append((alert_message, alert_type, alert_color))

                # Ø¥Ø¯Ø±Ø§Ø¬ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø¬Ø¯ÙŠØ¯
                with self.conn:
                    self.conn.execute("""
                        INSERT INTO attendance (
                            national_id, name, rank, course,
                            time, date, status, original_status,
                            registered_by, excuse_reason,
                            updated_by, updated_at
                        )
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    """, (
                        trainee[0], trainee[1], trainee[2], trainee[3],
                        current_time, current_date,
                        status, status,
                        self.current_user["full_name"], "",
                        "", ""
                    ))

                successful_ids.append(national_id)

            except Exception as e:
                print(f"Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù‡ÙˆÙŠØ© {national_id}: {str(e)}")
                failed_ids.append(national_id)

        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø±Ø³Ø§Ù„Ø© Ù…Ù„Ø®Øµ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        result_message = f"ØªÙ…Øª Ù…Ø¹Ø§Ù„Ø¬Ø© {len(id_lines)} Ø±Ù‚Ù… Ù‡ÙˆÙŠØ©:\n\n"

        if successful_ids:
            result_message += f"âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ {len(successful_ids)} Ù…ØªØ¯Ø±Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø­Ø§Ù„Ø© '{status}'.\n"

        if already_registered_ids:
            result_message += f"âš ï¸ {len(already_registered_ids)} Ù…ØªØ¯Ø±Ø¨ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….\n"

        if excluded_ids:
            result_message += f"âŒ {len(excluded_ids)} Ù…ØªØ¯Ø±Ø¨ Ù…Ø³ØªØ¨Ø¹Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±Ù‡Ù….\n"

        if failed_ids:
            result_message += f"â“ {len(failed_ids)} Ø±Ù‚Ù… Ù‡ÙˆÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."

        # Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        messagebox.showinfo("Ù†ØªØ§Ø¦Ø¬ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±", result_message)

        # ØªÙØ±ÙŠØº Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù†Øµ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†Ø§Ø¬Ø­Ø© Ø¥Ø°Ø§ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­
        if successful_ids:
            self.barcode_text.delete(1.0, tk.END)

        # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ±
        self.update_statistics()
        self.update_attendance_display()

        # Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…ØªÙƒØ±Ø± (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª)
        if absence_alerts:
            # Ø¹Ø±Ø¶ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† ØªÙ†Ø¨ÙŠÙ‡
            first_alert = absence_alerts[0]
            self.show_absence_alert(
                first_alert[0] + f"\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ù†Ø§Ùƒ {len(absence_alerts)} ØªÙ†Ø¨ÙŠÙ‡ ØºÙŠØ§Ø¨ Ù…ØªÙƒØ±Ø± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©."
                if len(absence_alerts) > 1 else first_alert[0],
                first_alert[1],
                first_alert[2]
            )

    def export_course_to_word(self, course_name):
        """ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø© Ø¥Ù„Ù‰ Ù…Ù„Ù ÙˆÙˆØ±Ø¯ Ù…Ø¹ Ø¬Ø¯ÙˆÙ„ Ø­Ø¶ÙˆØ± ÙØ§Ø±Øº Ù„Ù„Ø£ÙŠØ§Ù… Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù…ÙˆØ¯ÙŠ"""
        if not self.current_user["permissions"]["can_export_data"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return

        try:
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙƒØªØ¨Ø© python-docx
            if 'Document' not in globals():
                messagebox.showerror("Ø®Ø·Ø£",
                                     "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØªØ¨Ø© python-docx. Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: pip install python-docx")
                return

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© (ÙÙ‚Ø· ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†)
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT national_id, name, rank
                FROM trainees
                WHERE course=? AND is_excluded=0
                ORDER BY name
            """, (course_name,))
            students_data = cursor.fetchall()

            if not students_data:
                messagebox.showinfo("Ù…Ù„Ø§Ø­Ø¸Ø©", f"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù†Ø´Ø·ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© '{course_name}'")
                return

            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯
            doc = Document()

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (RTL) Ø¨ØªÙ†Ø³ÙŠÙ‚ Ø¹Ù…ÙˆØ¯ÙŠ
            section = doc.sections[0]
            section.page_width = Inches(8.27)  # A4 width in portrait
            section.page_height = Inches(11.69)  # A4 height in portrait
            section.left_margin = Inches(0.5)
            section.right_margin = Inches(0.5)
            section.top_margin = Inches(0.7)
            section.bottom_margin = Inches(0.7)

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø£Ø³ (Header) Ù…Ø¹ Ø®Ø· ÙØ§ØµÙ„
            header = section.header
            header_para = header.paragraphs[0]
            header_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
            header_run = header_para.add_run(f'ÙƒØ´Ù Ø­Ø¶ÙˆØ± ÙˆØºÙŠØ§Ø¨ Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¯ÙˆØ±Ø©: {course_name}')
            header_run.font.size = Pt(14)
            header_run.font.bold = True
            header_run.font.rtl = True

            # Ø¥Ø¶Ø§ÙØ© Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø±Ø£Ø³
            header_para = header.add_paragraph()
            header_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
            student_count_run = header_para.add_run(f'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†: {len(students_data)}')
            student_count_run.font.size = Pt(12)
            student_count_run.font.bold = True
            student_count_run.font.rtl = True

            # Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ø£ÙÙ‚ÙŠ Ø¨Ø¹Ø¯ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ø±Ø£Ø³
            header_para.paragraph_format.border_bottom = True

            # Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ø±Ø£Ø³
            today_date = datetime.datetime.now().strftime("%Y-%m-%d")
            header_para = header.add_paragraph()
            header_para.alignment = WD_ALIGN_PARAGRAPH.LEFT
            header_date = header_para.add_run(f'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {today_date}')
            header_date.font.size = Pt(9)
            header_date.font.rtl = True

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ°ÙŠÙŠÙ„ Ø¨Ø´ÙƒÙ„ Ø¨Ø³ÙŠØ·
            footer = section.footer
            footer_para = footer.paragraphs[0]
            footer_para.alignment = WD_ALIGN_PARAGRAPH.CENTER
            footer_text = footer_para.add_run('Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨ - Ù‚Ø³Ù… Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…Ø¯Ø±Ø¨ÙŠÙ†')
            footer_text.font.size = Pt(9)
            footer_text.font.rtl = True

            # Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø±Ø© ÙØ§ØµÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            doc.add_paragraph()

            # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨
            table = doc.add_table(rows=1, cols=8)
            table.style = 'Table Grid'

            # ØªØ¹Ø±ÙŠÙ Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            hdr_cells = table.rows[0].cells
            headers = ["Ø§Ù„Ø¹Ø¯Ø¯", "Ø§Ù„Ø§Ø³Ù…", "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"]

            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± (Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨)
            for i, header in enumerate(reversed(headers)):
                hdr_cells[i].text = header
                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ†
                hdr_cells[i].paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
                for run in hdr_cells[i].paragraphs[0].runs:
                    run.font.bold = True
                    run.font.size = Pt(11)
                    run.font.rtl = True

                # ØªØ·Ø¨ÙŠÙ‚ ØªØ¸Ù„ÙŠÙ„ Ù„Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø³ÙŠØ·Ø©
                try:
                    shading_elm = parse_xml(r'<w:shd {} w:fill="D9D9D9"/>'.format(nsdecls('w')))
                    hdr_cells[i]._element.get_or_add_tcPr().append(shading_elm)
                except:
                    # ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ØŒ Ù†ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ¸Ù„ÙŠÙ„
                    pass

            # Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†
            for i, student in enumerate(students_data):
                national_id, name, rank = student
                row_cells = table.add_row().cells

                # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± (Ø¹ÙƒØ³ Ø§Ù„ØªØ±ØªÙŠØ¨)
                # Ø§Ù„Ø¹Ø¯Ø¯ (ØªØ³Ù„Ø³Ù„ÙŠ)
                row_cells[7].text = str(i + 1)
                row_cells[7].paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER

                # Ø§Ù„Ø§Ø³Ù… - ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø§Ø°Ø§Ø© Ø¥Ù„Ù‰ ØªÙˆØ³ÙŠØ·
                row_cells[6].text = name
                row_cells[6].paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER

                # Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                row_cells[5].text = national_id
                row_cells[5].paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER

                # Ø§Ù„Ø£ÙŠØ§Ù… ØªØ¨Ù‚Ù‰ ÙØ§Ø±ØºØ© Ù„Ù„ØªØ¹Ø¨Ø¦Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
                for day_idx in range(5):
                    row_cells[day_idx].paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER

                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ØµÙ
                for cell in row_cells:
                    for paragraph in cell.paragraphs:
                        for run in paragraph.runs:
                            run.font.rtl = True
                            run.font.size = Pt(10)

            # Ø¶Ø¨Ø· Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ - Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù…
            table.autofit = False
            col_widths = [0.5, 2.6, 1.4, 0.7, 0.7, 0.7, 0.7, 0.7]  # Ø²ÙŠØ§Ø¯Ø© Ø¹Ø±Ø¶ Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§Ø³Ù… (2.6 Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 2.0)

            # ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„ÙƒÙ„ Ø¹Ù…ÙˆØ¯
            try:
                for i, width in enumerate(col_widths):
                    table.columns[i].width = Inches(width)
            except:
                # ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ØŒ Ù†ØªØ¬Ø§Ù‡Ù„ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶
                pass

            # Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            doc.add_paragraph()

            # Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª
            sig_table = doc.add_table(rows=1, cols=3)
            sig_table.style = 'Table Grid'
            sig_cells = sig_table.rows[0].cells

            sig_cells[2].text = "Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: _________________"
            sig_cells[1].text = "Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: ______________"
            sig_cells[0].text = "Ø§Ù„Ù…Ø¯ÙŠØ±: __________________"

            for cell in sig_cells:
                cell.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
                for run in cell.paragraphs[0].runs:
                    run.font.rtl = True
                    run.font.size = Pt(11)

            # Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            doc.add_paragraph()
            notes_para = doc.add_paragraph()
            notes_para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
            notes_para.add_run("Ù…Ù„Ø§Ø­Ø¸Ø§Øª:").bold = True

            # Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ· Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
            for _ in range(3):
                line_para = doc.add_paragraph("_" * 80)
                line_para.alignment = WD_ALIGN_PARAGRAPH.RIGHT

            # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            export_file = filedialog.asksaveasfilename(
                defaultextension=".docx",
                filetypes=[("Word documents", "*.docx")],
                initialfile=f"ÙƒØ´Ù_Ø­Ø¶ÙˆØ±_{course_name}.docx"
            )

            if export_file:
                doc.save(export_file)
                messagebox.showinfo("Ù†Ø¬Ø§Ø­", f"ØªÙ… ØªØµØ¯ÙŠØ± ÙƒØ´Ù Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ø¯ÙˆØ±Ø© '{course_name}' Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰:\n{export_file}")
                # ÙØªØ­ Ø§Ù„Ù…Ù„Ù Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØµØ¯ÙŠØ±
                try:
                    os.startfile(export_file)
                except:
                    # ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ø¯Ù… ØªÙ…ÙƒÙ† Ø§Ù„Ù†Ø¸Ø§Ù… Ù…Ù† ÙØªØ­ Ø§Ù„Ù…Ù„ÙØŒ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø®Ø·Ø£
                    pass

        except Exception as e:
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙˆØ±Ø©: {str(e)}")

    def export_course_diligence_behavior(self, course_name):
        """ÙˆØ¸ÙŠÙØ© ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ Ù„Ù„Ø¯ÙˆØ±Ø© Ø¨ØªÙ†Ø³ÙŠÙ‚ Word Ù…Ø¹ ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø©"""
        if not self.current_user["permissions"]["can_export_data"]:
            messagebox.showwarning("ØªÙ†Ø¨ÙŠÙ‡", "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
            return

        try:
            # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…ÙƒØªØ¨Ø© python-docx
            if 'Document' not in globals():
                messagebox.showerror("Ø®Ø·Ø£",
                                     "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…ÙƒØªØ¨Ø© python-docx. Ù‚Ù… Ø¨ØªØ«Ø¨ÙŠØªÙ‡Ø§ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù…: pip install python-docx")
                return

            # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© (ÙÙ‚Ø· ØºÙŠØ± Ø§Ù„Ù…Ø³ØªØ¨Ø¹Ø¯ÙŠÙ†)
            cursor = self.conn.cursor()
            cursor.execute("""
                SELECT national_id, name, rank
                FROM trainees
                WHERE course=? AND is_excluded=0
                ORDER BY name
            """, (course_name,))
            students_data = cursor.fetchall()

            if not students_data:
                messagebox.showinfo("Ù…Ù„Ø§Ø­Ø¸Ø©", f"Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ù†Ø´Ø·ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© '{course_name}'")
                return

            # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø§ÙØ°Ø© Ø­Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± ØªÙ‚Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ±
            progress_window = tk.Toplevel(self.root)
            progress_window.title("Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ")
            progress_window.geometry("400x150")
            progress_window.configure(bg=self.colors["light"])
            progress_window.transient(self.root)
            progress_window.resizable(False, False)
            progress_window.grab_set()

            x = (progress_window.winfo_screenwidth() - 400) // 2
            y = (progress_window.winfo_screenheight() - 150) // 2
            progress_window.geometry(f"400x150+{x}+{y}")

            tk.Label(
                progress_window,
                text=f"Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ Ù„Ø¯ÙˆØ±Ø©: {course_name}",
                font=self.fonts["text_bold"],
                bg=self.colors["light"],
                pady=10
            ).pack()

            progress_var = tk.DoubleVar()
            progress_bar = ttk.Progressbar(
                progress_window,
                variable=progress_var,
                maximum=100,
                length=350
            )
            progress_bar.pack(pady=10)

            status_label = tk.Label(
                progress_window,
                text="Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØºÙŠØ§Ø¨...",
                font=self.fonts["text"],
                bg=self.colors["light"]
            )
            status_label.pack(pady=5)

            progress_window.update()

            # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªÙ†Ø¯ Ø¬Ø¯ÙŠØ¯
            doc = Document()

            # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (RTL)
            section = doc.sections[0]
            section.page_width = Inches(8.27)  # A4 width
            section.page_height = Inches(11.69)  # A4 height
            section.left_margin = Inches(0.7)
            section.right_margin = Inches(0.7)
            section.top_margin = Inches(0.7)
            section.bottom_margin = Inches(0.7)

            # Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            title = doc.add_heading(f'Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¯ÙˆØ±Ø©: {course_name}', level=0)
            title.alignment = WD_ALIGN_PARAGRAPH.CENTER
            for run in title.runs:
                run.font.size = Pt(16)
                run.font.bold = True
                run.font.rtl = True

            # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„ØªØ§Ø±ÙŠØ®
            date_info = doc.add_paragraph()
            date_info.alignment = WD_ALIGN_PARAGRAPH.LEFT
            today_date = datetime.datetime.now().strftime("%Y-%m-%d")
            date_run = date_info.add_run(f'ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: {today_date}')
            date_run.font.size = Pt(10)
            date_run.font.rtl = True

            # Ø¥Ø¶Ø§ÙØ© Ø®Ø· Ø£ÙÙ‚ÙŠ
            border_paragraph = doc.add_paragraph()
            border_paragraph.paragraph_format.border_bottom = True

            # Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ
            table = doc.add_table(rows=1, cols=6)
            table.style = 'Table Grid'

            # Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±)
            hdr_cells = table.rows[0].cells
            headers = ["Ø¹Ø¯Ø¯", "Ø§Ù„Ø§Ø³Ù…", "Ø§Ù„Ø±ØªØ¨Ø©", "Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©", "Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©", "Ø§Ù„Ø³Ù„ÙˆÙƒ"]

            for i, header in enumerate(headers):
                # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±)
                idx = len(headers) - i - 1
                hdr_cells[idx].text = header
                hdr_cells[idx].paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
                for run in hdr_cells[idx].paragraphs[0].runs:
                    run.font.bold = True
                    run.font.size = Pt(12)
                    run.font.rtl = True

                # ØªØ·Ø¨ÙŠÙ‚ ØªØ¸Ù„ÙŠÙ„ Ù„Ù„Ø±Ø£Ø³
                try:
                    shading_elm = parse_xml(r'<w:shd {} w:fill="D9D9D9"/>'.format(nsdecls('w')))
                    hdr_cells[idx]._element.get_or_add_tcPr().append(shading_elm)
                except:
                    pass

            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ù…ØªØ¯Ø±Ø¨ ÙˆØ­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©
            student_scores = []
            total_students = len(students_data)

            for index, student in enumerate(students_data):
                national_id, name, rank = student

                # ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                progress_var.set((index / total_students) * 80)  # 80% Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
                status_label.config(text=f"Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ {index + 1} Ù…Ù† {total_students}: {name}")
                progress_window.update()

                # Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©:
                # 1. Ø§Ù„Ø¯Ø±Ø¬Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù‡ÙŠ 100
                # 2. Ø®ØµÙ… 4 Ø¯Ø±Ø¬Ø§Øª Ù„ÙƒÙ„ ØºÙŠØ§Ø¨ ÙƒØ§Ù…Ù„
                # 3. Ø®ØµÙ… 1 Ø¯Ø±Ø¬Ø© Ù„ÙƒÙ„ ØªØ£Ø®ÙŠØ±
                # 4. Ø®ØµÙ… 0.5 Ø¯Ø±Ø¬Ø© Ù„ÙƒÙ„ ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±

                # Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø¹Ù† Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„Ù…ØªØ¯Ø±Ø¨
                cursor.execute("""
                    SELECT status
                    FROM attendance
                    WHERE national_id=?
                """, (national_id,))
                attendance_records = cursor.fetchall()

                diligence_score = 100.0  # Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù…Ù† 100

                for record in attendance_records:
                    status = record[0]
                    if status == "ØºØ§Ø¦Ø¨" or status == "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±":  # ØªØ¹Ø¯ÙŠÙ„: Ø®ØµÙ… 4 Ù†Ù‚Ø§Ø· Ù„Ù€ "ØºØ§Ø¦Ø¨ Ø¨Ø¹Ø°Ø±"
                        diligence_score -= 4.0
                    elif status == "Ù…ØªØ£Ø®Ø±":
                        diligence_score -= 1.0
                    elif status == "Ø­Ø§Ù„Ø© ÙˆÙØ§Ø©" or status == "Ù…Ù†ÙˆÙ…":  # Ø¥Ø¶Ø§ÙØ©: Ø®ØµÙ… 0.5 Ù†Ù‚Ø·Ø© Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        diligence_score -= 0.5

                # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ù†Ø²ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø© Ø¹Ù† ØµÙØ±
                diligence_score = max(0, diligence_score)

                # Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ Ù…Ø¹ Ø§Ù„Ø¯Ø±Ø¬Ø©
                student_scores.append((national_id, name, rank, diligence_score))

            # ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ØªØµØ§Ø¹Ø¯ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© (Ø§Ù„Ø£Ù‚Ù„ ÙŠØ£ØªÙŠ Ø£ÙˆÙ„Ø§Ù‹)
            student_scores.sort(key=lambda x: x[3])

            # Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±ØªÙŠØ¨
            for index, (national_id, name, rank, diligence_score) in enumerate(student_scores):
                # ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
                progress_var.set(80 + (index / total_students) * 15)  # 15% Ù„Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø¥Ø¶Ø§ÙØ©
                status_label.config(text=f"Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØªØ¯Ø±Ø¨ {index + 1} Ù…Ù† {total_students} Ø¥Ù„Ù‰ Ø§Ù„ØªÙ‚Ø±ÙŠØ±")
                progress_window.update()

                # Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ Ø¯Ø§Ø¦Ù…Ù‹Ø§ 100
                behavior_score = 100.0

                # Ø¥Ø¶Ø§ÙØ© ØµÙ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ØªØ¯Ø±Ø¨
                row_cells = table.add_row().cells

                # Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±
                row_cells[5].text = str(index + 1)  # Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ØªØ³Ù„Ø³Ù„ÙŠ
                row_cells[4].text = name  # Ø§Ù„Ø§Ø³Ù…
                row_cells[3].text = rank  # Ø§Ù„Ø±ØªØ¨Ø©
                row_cells[2].text = national_id  # Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©
                row_cells[1].text = f"{diligence_score:.1f}"  # Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© Ø¨Ø¯Ù‚Ø© Ø±Ù‚Ù… Ø¹Ø´Ø±ÙŠ ÙˆØ§Ø­Ø¯
                row_cells[0].text = f"{behavior_score:.0f}"  # Ø§Ù„Ø³Ù„ÙˆÙƒ (Ø¯Ø§Ø¦Ù…Ù‹Ø§ 100)

                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ù„Ø§ÙŠØ§
                for cell in row_cells:
                    cell.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
                    for run in cell.paragraphs[0].runs:
                        run.font.rtl = True
                        run.font.size = Pt(11)

                # ØªÙ„ÙˆÙŠÙ† Ø§Ù„ØµÙ Ø­Ø³Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©
                if diligence_score < 90:  # Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø£Ù‚Ù„ Ù…Ù† 90ØŒ ØªÙ…ÙŠÙŠØ²Ù‡Ø§ Ø¨Ù„ÙˆÙ† ÙØ§ØªØ­
                    try:
                        for cell in row_cells:
                            shading_elm = parse_xml(r'<w:shd {} w:fill="FFDDDD"/>'.format(nsdecls('w')))
                            cell._element.get_or_add_tcPr().append(shading_elm)
                    except:
                        pass

            # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            table.autofit = False
            try:
                # ØªØ¹ÙŠÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ø¨ÙˆØµØ©)
                widths = [0.8, 0.8, 1.2, 1.5, 2.5, 0.5]  # Ø§Ù„Ø³Ù„ÙˆÙƒØŒ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©ØŒ Ø§Ù„Ù‡ÙˆÙŠØ©ØŒ Ø§Ù„Ø±ØªØ¨Ø©ØŒ Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ø¹Ø¯Ø¯
                for i, width in enumerate(widths):
                    table.columns[i].width = Inches(width)
            except:
                pass

            # Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø±Ø© ÙØ§ØµÙ„Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            doc.add_paragraph()

            # Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙˆÙ„ Ù„Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª
            signature_table = doc.add_table(rows=1, cols=3)
            signature_table.style = 'Table Grid'

            sig_cells = signature_table.rows[0].cells
            sig_cells[2].text = "Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±: _________________"
            sig_cells[1].text = "Ø±Ø¦ÙŠØ³ Ø§Ù„Ù‚Ø³Ù…: __________________"
            sig_cells[0].text = "Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¯Ø±ÙŠØ¨: ________________"

            for cell in sig_cells:
                cell.paragraphs[0].alignment = WD_ALIGN_PARAGRAPH.CENTER
                for run in cell.paragraphs[0].runs:
                    run.font.rtl = True
                    run.font.size = Pt(11)

            # Ø¥Ø¶Ø§ÙØ© Ù†Øµ ØªÙˆØ¶ÙŠØ­ÙŠ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            doc.add_paragraph()
            note_para = doc.add_paragraph()
            note_para.alignment = WD_ALIGN_PARAGRAPH.RIGHT
            note_run = note_para.add_run("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©:")
            note_run.font.bold = True
            note_run.font.rtl = True

            notes = [
                "- ØªØ¨Ø¯Ø£ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© Ù…Ù† 100 Ø¯Ø±Ø¬Ø©.",
                "- ÙŠØªÙ… Ø®ØµÙ… 4 Ø¯Ø±Ø¬Ø§Øª Ø¹Ù† ÙƒÙ„ ÙŠÙˆÙ… ØºÙŠØ§Ø¨.",
                "- ÙŠØªÙ… Ø®ØµÙ… 4 Ø¯Ø±Ø¬Ø§Øª Ø¹Ù† ÙƒÙ„ ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø±.",
                "- ÙŠØªÙ… Ø®ØµÙ… 1 Ø¯Ø±Ø¬Ø© Ø¹Ù† ÙƒÙ„ Ø­Ø§Ù„Ø© ØªØ£Ø®ÙŠØ±.",
                "- ÙŠØªÙ… Ø®ØµÙ… 0.5 Ø¯Ø±Ø¬Ø© Ø¹Ù† ÙƒÙ„ Ø­Ø§Ù„Ø© ÙˆÙØ§Ø©.",
                "- ÙŠØªÙ… Ø®ØµÙ… 0.5 Ø¯Ø±Ø¬Ø© Ø¹Ù† ÙƒÙ„ Ø­Ø§Ù„Ø© Ù…Ù†ÙˆÙ….",
                "- Ø¯Ø±Ø¬Ø© Ø§Ù„Ø³Ù„ÙˆÙƒ 100 Ø¯Ø±Ø¬Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹."
            ]

            for note in notes:
                p = doc.add_paragraph()
                p.alignment = WD_ALIGN_PARAGRAPH.RIGHT
                p.add_run(note).font.rtl = True

            # ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
            progress_var.set(95)
            status_label.config(text="ÙØªØ­ Ø­ÙˆØ§Ø± Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù...")
            progress_window.update()

            # Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªÙ†Ø¯
            export_file = filedialog.asksaveasfilename(
                defaultextension=".docx",
                filetypes=[("Word documents", "*.docx")],
                initialfile=f"Ø¨ÙŠØ§Ù†_Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø©_ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ_{course_name}.docx"
            )

            if export_file:
                progress_var.set(95)
                status_label.config(text="Ø¬Ø§Ø±ÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù...")
                progress_window.update()

                doc.save(export_file)

                progress_var.set(100)
                status_label.config(text="ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù† Ø¨Ù†Ø¬Ø§Ø­!")
                progress_window.update()

                # Ø¥ØºÙ„Ø§Ù‚ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø¹Ø¯ Ø«Ø§Ù†ÙŠØªÙŠÙ†
                progress_window.after(2000, progress_window.destroy)

                messagebox.showinfo("Ù†Ø¬Ø§Ø­",
                                    f"ØªÙ… ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ Ù„Ù„Ø¯ÙˆØ±Ø© '{course_name}' Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰:\n{export_file}")

                # Ù…Ø­Ø§ÙˆÙ„Ø© ÙØªØ­ Ø§Ù„Ù…Ù„Ù ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
                try:
                    os.startfile(export_file)
                except:
                    pass
            else:
                progress_window.destroy()

        except Exception as e:
            try:
                progress_window.destroy()
            except:
                pass
            messagebox.showerror("Ø®Ø·Ø£", f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù† Ø§Ù„Ù…ÙˆØ§Ø¸Ø¨Ø© ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ: {str(e)}")

